# Руководство пользователя

Данная инструкция имеет общий характер и предназначена для пользователей.
Более подробная информация по устройству,
а также инструкции по сборке находится на странице https://github.com/sportiduino/sportiduino/


[Общая информация](#общая-информация)

[Инструкция для участников](#инструкция-для-участников)

[Инструкция для постановщиков](#инструкция-для-постановщиков)

[Подготовка чипов участников](#подготовка-чипов-участников)

[Подготовка базовых станций](#подготовка-базовых-станций)

[Проверка базовых станций](#проверка-базовых-станций)

[Чтение чипов и формирование результатов](#чтение-чипов-и-формирование-результатов)

## Общая информация

### Чипы

Поддерживаемые чипы:
- [Mifare Ultralight C](http://www.nxp.com/documents/data_sheet/MF0ICU2.pdf) на 36 отметок
- [Mifare Classic 1K](https://www.nxp.com/docs/en/data-sheet/MF1S50YYX_V1.pdf) на 42 отметки
- [Mifare Classic 4K](https://www.nxp.com/docs/en/data-sheet/MF1S70YYX_V1.pdf) на 90 отметок
- [NTAG213/215/216](https://www.nxp.com/docs/en/data-sheet/NTAG213_215_216.pdf) на 32/120/216 отметок

Они производятся в разном форм-факторе.
Чипы с небольшой антенной могут неуверенно срабатывать на станциях.
Рекомендуются для использования чипы NTAG.

### Базовые станции

Представляют собой небольшие коробочки с фланцами, весят около 150 грамм.
Питание от 3 батареек АА, в зависимости от режима работы батареек хватает от 45 дней до 2 лет.
Кнопок и другого интерфейса на станции нет.
Весь обмен информацией и запись чипов происходит в бесконтактном режиме.
Оптимальная зона срабатывания 0,5 - 2 см над станцией.

![](/Images/BaseStation1.jpg?raw=true)

![](/Images/2017_09_30_09_34_45.jpg?raw=true)

В станции установлена микросхема часов реального времени, обладающая малой погрешностью хода,
но станции не являются прибором точного времени, время нужно регулярно корректировать.

Для обеспечения более длительной работы от батареи базовые станции могут работать в трех режимах:

* **Спящий режим.**
Для хранения станций между соревнованиями.
Опрос чипа происходит раз в 25 секунд. Практически не потребляют энергию.
Батарей хватит более чем на 2 года.
Для перевода в данный режим используются специально записанные мастер-чипы.
Вывод осуществляется прикладыванием любого чипа или чипа с магнитом для мгновенного срабатывания.
Магнит при этом нужно прикладывать к середине левого края лицевой стороны станции.
Также при выводе из сна происходит очистка внутренней памяти.
* **Режим ожидания.**
Опрос чипа раз в 1 секунду. Батарей хватит примерно на полгода.
* **Рабочий режим.**
Опрос чипа раз в 0,25 секунд. Самый быстрый режим отметки. Батарей хватит на 45 дней.

Базовые станции в зависимости от заданного им номера (от 1 до 255) могут выполнять разные функции:

- 1 - 239 — обычные станции отметки.
При поднесении чипа записывают в него отметку и подают сигнал.
При повторном поднесении чипа не производят запись, подают двойной сигнал.
В режиме проверки станцией наличия отметки старта/финиша в чипе не производят отметку и не сигналят для чипов, в которых нет соответствующих отметок.
- 240 – станция старта.
В режиме проверки станцией старта/финиша не производят отметку и не сигналят, если чип не пустой.
В обычном режиме записывает отметку как обычные базовые станции.
- 245 – станция финиша.
Записывает отметку как обычная базовая станция.
- 248 – станция проверки.
Если чип пустой и время его инициализации/очистки не отстает более чем на месяц от текущего, станция подаёт одиночный сигнал, иначе – молчит.
Станция ничего не записывает на чип и работает по скорости как обычная, так что на ней участники могут потренироваться в отметке перед стартом.
- 249 – станция очистки. Стирает все данные на чипе, оставляя неизменным номер, а также обновляет время инициализации на чипе.
При поднесении чипа загорается светодиод и мигает все время процедуры очистки, звуковой сигнал говорит об успешности процедуры.

### Мастер станция

Станция с разъемом USB для подключения к компьютеру.
Нужна для настройки системы, записи и считывания чипов.

![](/Images/MasterStation1.jpg?raw=true)

## Инструкция для участников

С данной инструкцией очень желательно ознакомить участников до начала соревнований.

* Для отметки нужно поднести чип примерно к центру белого круга на лицевой стороне станции.
* В случае успешной отметки станция издаст звуковой сигнал и мигнет один раз светодиодом.
* Оптимальный диапазон срабатывания 0,5 - 2 см. 
* Если чип далеко от станции, отметка может сработать не с первого раза.
* При отметке не нужно двигать чип из стороны в сторону, это затрудняет чтение и запись чипа.
* Если не получилось отметиться, уберите чип и вновь поднесите его, медленно опуская его к центру белого круга на станции.
* Время отметки составляет от 0,06 до 0,4 секунды, если станция находится в рабочем режиме.
* Если Вы пришли на станцию первым, её, возможно, нужно разбудить, время отметки в таком случае составит от 0,06 до 1,2 секунды.
* При попытке повторной отметки станция издаст два коротких сигнала без записи новой отметки.
Если не уверены, отметились ли вы с первого раза, стоит повторить.
* Без отметки на стартовой станции чипы могут не срабатывать, в данном случае нужно вернуться на старт.
* Если вы пришли на КП одновременно с другим участником, то отмечаться нужно по очереди.
Нельзя одновременно приложить к станции отметки два и более чипа, в этом случае отметка будет записана только на один из чипов.

## Инструкция для постановщиков

Для работы со станциями необходимо использовать программы:
* SportiduinoPQ для подготовки чипов участников, настройка станций;
* SportOrg для чтения чипов и подсчёта результатов соревнований.

Программу SportiduinoPQ можно скачать [на странице](https://github.com/sportiduino/SportiduinoPQ/releases).
В релизе присутствует портативный exe файл для Windows, не требующий установки.
При работе программы весь лог сохраняется в подпапку log.

Программа SportOrg доступна по адресу https://github.com/sportorg/pysport
Там же размещена ссылка на инструкцию пользователя.

### Подключение мастер-станции

Для подключения станции нужно нажать кнопку `Подкл.` (`Connect`).
Если подключение удалось, в логе отобразится `Master station is connected`.

![](/Images/SportiduinoPQ-Connect.jpg?raw=true)

Если подключить станцию не удается, проверьте правильность соединения.
Проблемы могут возникнуть, если в системе используется другое устройство, связанное через Com порт.
В таком случае нужно через Диспетчер устройств в Панели управления Windows выяснить номер Com порта, присваиваемый станции и выбрать его вместо "auto".
Также для станции на Arduino Nano с чипом CHG340 необходимо установить соответствующий драйвер.

### Подготовка чипов участников

Пустые чипы необходимо инициализировать (записать на них номер и текущее время).
Для этого во вкладке `Осн.` (`Main`) надо ввести номер чипа в поле `Чип №`.
Далее поднести чип к станции и нажать кнопку `Подготовить чип` (`Init Card`).
Процесс инициализации занимает в зависимости от чипа от 3 до 7 секунд.
В случае успеха станция издаст один сигнал.
Если стоит галочка `Автоувеличение` (`Autoincrement`), то число в поле ввода увеличится на 1.
Если процесс прошел неудачно (несколько коротких сигнала), попробуйте повторить процедуру.

![](/Images/SportiduinoPQ-InitCard.jpg?raw=true)

Номер чипа можно задать в диапазоне от 1 до 65535.
Но базовые станции при отметке чипов с номером более 4000 не будут записывать факт отметки во внутреннюю память.

При инициализации помимо номера чипа записывается и время инициализации,
которое необходимо для последующего считывания чипа.
Если с момента инициализации или очистки прошло более полугода, данные будут некорректными.
Поэтому желательно инициализировать чипы незадолго до соревнований.

Уже ранее инициализированные чипы можно очистить с сохранением номера на станции очистки.

## Подготовка базовых станций

### Быстрая подготовка базовой станции

Для быстрой подготовки базовой станции по UART используется преобразователь USB-to-TTL .

![](/Images/ProgrammerWire.jpg?raw=true)

Подключите его к разъёму Prog базовой станции (без подключения DTR).

Не имеет значение находится станция в активном режиме или режиме сна.
Если станция спит, то будить её не надо.
В программе SportduinoPQ во вкладке `Конф.` (`Config`) в разделе `Настройка по UART` (`Config by UART`)
установите номер Com-порта преобразователя USB-to-TTL и нажмите кнопку `Записать` (`Write`).
При этом в базовую станцию будет записано текущее время и все остальные настройки.

![](/Images/SportiduinoPQ-ConfigByUart.jpg?raw=true)

Чтобы убедиться, что настройки записались правильно нажмите на кнопку `Читать` (`Read`).
После чего на экране появятся текущие настройки станции. При этом режим станции не изменится.

![](/Images/SportiduinoPQ-ConfigByUart2.jpg?raw=true)

**Внимание!**
Правильно установите текущий пароль в программе SportduinoPQ.
После сборки станции пароль по умолчанию 0,0,0.
Если вы не правильно установите пароль, то базовая станция не примет настройки с мастер-чипа.
Сбросить пароль можно, записав новые настройки по UART.

![](/Images/SportiduinoPQ-Pwd.jpg?raw=true)

### Мастер-чипы

Другой и основной способ настройки станции — это мастер-чипы.
Мастер-чип – это обыкновенный чип с записанными на него настройками или командами для передачи их на базовую станцию.
Чтобы записать мастер-чип, нужно поднести его к мастер-станции и нажать нужную кнопку на вкладке `Чип` (`Card`) в зависимости от задачи.
Рекомендуется отобрать один или несколько чипов для использования в качестве мастер-чипов и пометить их,
чтобы избежать попадание их в кучу с чипами участников.

Для настройки станций, если они находится в состоянии сна, необходимо их сначала разбудить.
Для этого поднести любой чип участника на время до 30 секунд.
Загорится светодиод на 3 секунды, после чего станция подаст длинный сигнал (батарея в норме) или серию коротких (необходимо заменить).

### Настройка времени станции

Для настройки времени нужно приложить любой чип к мастер-станции и нажать `Создать` (`Create`) в разделе `Мастер-чип "Часы"` (`Date/Time Card`) на вкладке `Чип` (`Card`).

![](/Images/SportiduinoPQ-DateTimeCreate.jpg?raw=true)

Станция издаст четыре сигнала с интервалом в секунду.
После третьего сигнала нужно приложить чип к базовой станции.
При этом станция издаст длинный сигнал.
Если последний сигнал мастер станции и сигнал базовой станции слились в один, то время настроено достаточно точно.
Настройку времени лучше проводить в рабочем режиме станции в виду более короткого периода опроса чипов.

Погрешность хода часов при условии использования качественных компонентов и соблюдения технологии пайки составляет 1 секунду в неделю.
Для критически важных станций старта и финиша рекомендуется обновлять время в день соревнований.

### Присвоение номера станции

В программе SportiduinoPQ на вкладке `Чип` (`Card`) указать номер станции (от 1 до 239),
поднести чип к станции и нажать кнопку `Создать`.
После чего данный чип поднести к станции.
Станция издаст один длинный сигнал подтверждения. 

Для задания специальных станций выделены отдельные кнопки.

![](/Images/SportiduinoPQ-SetNum.jpg?raw=true)

### Перевод станций в спящий режим

После соревнований рекомендуется перевести все станции в спящий режим для продления работы от батарей.
Для этого нужно поднести чип к мастер-станции.
В программе SportiduinoPQ на вкладке `Чип` (`Card`) нажать `Создать` в разделе `Мастер-чип "Сон"` (`Sleep Card`).
Затем поднести созданный мастер-чип к базовой станции.
Станция издаст 4 сигнала, и войдёт в спящий режим.
Для вывода станций из этого режима нужно приложить к ней чип участника на время до 30 секунд.

![](/Images/SportiduinoPQ-SetSleep.jpg?raw=true)

При создании мастер-чипа для перевода базовой станции в режим сна,
вы можете указать дату автоматического пробуждения станции в поле `Время пробуждения`.
В это время базовая станция автоматически перейдёт в активный режим и первому участнику не придётся будить станцию.
Если вы хотите перевести базовые станции в режим сна для хранения, то укажите любую прошедшую дату и время.

### Другие настройки базовой станции

Продолжительность активного режима, дополнительные проверки и усиление антенны базовой станции можно задать на вкладке `Конф.` (`Config`),
и записать на станцию с помощью мастер-чипа.

![](/Images/SportiduinoPQ-OtherSettings.jpg?raw=true)

Использование паролей защищает станции от возможности несанкционированного их перепрограммирования.
После сборки пароль по умолчанию 0, 0, 0.
Если вы установите новый пароль и забудете его, то для сброса пароля понадобится обновление настроек по UART.
Рекомендуется сохранить пароль в надёжном месте.

Настройки подробнее:
- `Active Time` — время работы в активном режиме.
Если в течение этого времени на станции никто не отметится, то станция перейдёт в режим ожидания (не в сон).
- `Start/Finish` — включает проверку на чипах участников отметку на стартовой станции.
- `Check InitTime` — включает проверку времени инициализации чипа участника.
- `Fast Mark` — включает режим быстрой отметки.
При этом сокращается время ожидания участником, когда базовая станция записывает отметку на чип участника.
Но также при этом сокращается ресурс чипов участников и чипы будут быстрее выходить из строя.
- `Antenna Gain` — коэффициент усиления антенны модуля MFRC522.

Мощность антенны по умолчанию 33 дБ.
Если задать максимальную мощность, то в некоторых станциях чипы перестают отмечаться при поднесении их вплотную.
Для станций с этой проблемой нужно постепенно уменьшать мощность до достижения оптимального срабатывания.

### Снятие лога станции

В ходе работы базовая станция ведет лог – записывает номера чипов и время отметки или только номера чипов.
Лог ведется только для чипов с номерами до 4000.
С использованием этой функции возможно восстановление части данных в случае утери чипов, проверки спорных ситуаций, а также в поиске сошедших или потерявшихся участников.
Лог базовой станции очищается при переходе в режим сна, если записываются только номера чипов.

Для снятия лога нужно записать мастер-чип.
Для этого поднести чип к мастер станции и в программе SportiduinoPQ нажать `Создать` в разделе `Мастер-чир "Лог отм."` (`Dump Card`) на вкладке `Чип` (`Card`).
После чего поднести мастер чип к базовой станции.
Процесс длительный, нужно аккуратно держать чип в оптимальной области записи (0.5 - 2 см над центром белого круга).
После успешного снятия лога поднести чип к мастер-станции и нажать `Читать` в разделе `Мастер-чир "Лог отм."` (`Dump Card`).
Результат появится в логе программы.

![](/Images/SportiduinoPQ-SetDump.jpg?raw=true)

### Проверка базовых станций

Чтобы проверить настройки базовой станции, уровень заряда батареек, время и текущий режим её работы,
создайте в программе SportiduinoPQ мастер-чип для чтения состояния станции.
Для этого во вкладке `Чип` (`Card`) нажмите `Создать` в разделе `Мастер-чип "Состояние"` (`State Card`).
После этого поднесите созданный мастер-чип к базовой станции.
Если базовая станция находится в режиме сна, то нужно будет подождать в течение 30 секунд.
Базовая станция включит светодиод на 3 секунды и издаст одиночный звуковой сигнал, после чего мастер-чип следует убрать.
Если базовая станция находилась в режиме сна, то она так в нём и останется, её не нужно переводить заново в режим сна.
Если в течение 30 секунд базовая станция никак не реагирует на чип, то либо она неисправна, либо сели батарейки, либо следует пересоздать мастер-чип.
После того как базовая станция записала информацию на мастер-чип, приложите мастер-чип к станции сопряжения и в программе SportidunoPQ нажмите `Читать` в том же разделе.
После этого в логе отобразится вся информация о базовой станции.
Также изменятся значения полей во всех вкладках SportiduinoPQ в соответствии с текущими настройками базовой станции.

![](/Images/SportiduinoPQ-GetInfo.jpg?raw=true)

## Чтение чипов и формирование результатов

Для чтения чипов и формирования результатов рекомендуется использовать программу SportOrg.
Особенность использования данной программы заключается в том, что необходимо использовать стартовую станцию (240) и финишную станцию (245), иначе при чтении будет происходить ошибка.
Можно предварительно отметить все чипы на станции старта, раздать участникам, а дальше в программе задать время старта либо задать отсчет старта от произвольной станции.
Также рекомендуется перевести станции в режим работы с проверкой старта/финиша, чтобы избежать ошибки.

Для быстрого просмотра результатов по отдельным чипам можно также использовать SportiduinoPQ.
Для этого поднести чип к станции и во вкладке `Осн.` (`Main`) нажать `Прочитать чип` (`Read Card`).
Результат отобразится в логе.

![](/Images/SportiduinoPQ-ReadCard.jpg?raw=true)

